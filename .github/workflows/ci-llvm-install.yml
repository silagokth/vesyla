name: Install LLVM with MLIR

on:
  workflow_call:
  workflow_dispatch:

env:
  LLVM_CIR_COMMIT_HASH: 4820d600ed3362744372983068495f086c9a0659
  LLVM_SOURCE_PATH: ${{ github.workspace }}/llvm-project
  LLVM_INSTALL_PATH: ${{ github.workspace }}/llvm-install
  LLVM_BUILD_PATH: ${{ github.workspace }}/llvm-build

jobs:
  llvm-install:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: true
        path: vesyla

    - name: Setup cmake
      uses: jwlawson/actions-setup-cmake@v2

    - name: Restore LLVM Cache if available
      id: cache-llvm
      uses: actions/cache@v4
      env:
        cache-name: cache-llvm
      with: 
        path: |
          ${{ env.LLVM_INSTALL_PATH }}
          ${{ env.LLVM_SOURCE_PATH }}
          ${{ env.LLVM_BUILD_PATH }}
        key: ${{ runner.os }}-llvm-${{ env.LLVM_CIR_COMMIT_HASH }}
        restore-keys: |
          ${{ runner.os }}-llvm-${{ env.LLVM_CIR_COMMIT_HASH }}
          ${{ runner.os }}-llvm-

    - name: Check if LLVM is already installed
      id: check-llvm
      uses: ./vesyla/.github/actions/check-llvm-install
      with:
        llvm-install-path: ${{ env.LLVM_INSTALL_PATH }}
        llvm-source-path: ${{ env.LLVM_SOURCE_PATH }}
        llvm-build-path: ${{ env.LLVM_BUILD_PATH }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git build-essential cmake python-is-python3 zlib1g-dev ninja-build clang lld wget
        pip3 install PyYAML


    - name: Install LLVM with CIR and MLIR
      run: |
        echo $(ls ${{ github.workspace }}/vesyla/scripts/)
        bash ${{ github.workspace }}/vesyla/scripts/llvm-cir-install.sh -y

